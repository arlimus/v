#!/usr/bin/env ruby

require "parseconfig"
require "trollop"

# For a given array, get the first entry or an alternative
# e.g. getFirstOr(Array.new,1) returns 1
# e.g. getFirstOr(Array.new(1,2),1) returns 2
def getFirstOr(a,alt)
  return alt if a == nil 
  return alt if a.empty?
  a.first
end

opts = Trollop::options do
  opt :pretend, "Pretend, don't execute"
  opt :verbose, "Let me know what is happening."
end


class FileViewer
  # contains the result of parsing commandline arguments
  attr :args

  # parse arguments
  def initialize(opts)
    @opts = opts
    parseArgs
  end

  # run a given file
  # e.g. for "vid.mkv" execute "mplayer vid.mkv"
  def run( file )
    mime = getMime file
    puts "-- got mime '#{mime}' for #{file}" if @opts[:verbose]
    runner = (mime != nil) ? getRunner( mime ) : nil
    puts "-- got runner '#{runner}' for #{file}" if @opts[:verbose]
    if runner == nil
      p "ee couldn't find a runner for #{mime}"
    else 
      exec = fillRunnerArgs file, runner
      puts "++ #{exec}"
      `#{exec}` if not @opts[:pretend]
    end
  end

  # run all files that were given as arguments
  def runAll
    @args["files"].each{|f| run f }
  end

  # for a given file, return the mime-type
  # e.g. for "vid.mkv" returns "video/x-matroska"
  def getMime( file )
    mimeMatch = `file --mime "#{file}"`.match(/: ([^;]*)/)
    return nil if mimeMatch == nil

    mimeMatch[1]
  end




  private

  def parseArgs
    def getArgs(&f)
      ARGV.map{|a|
        f.call(a)
      }.compact
    end

    @args = {
      "icon"    => "",
      "caption" => "v",
      "db"      => [],
      "factor"  => [],
      "files"   => []
    }
    
    @args["files"] = getArgs{ |c|
      cf = File.expand_path(c)
      File.exists?( cf ) ? cf : nil 
    }

    @args["db"] = getArgs{ |c|
      m = /^([+-][0-9]+)db$/i.match(c)
      m == nil ? nil : m[1]
    }

    @args["factor"] = getArgs{ |c|
      m = /^([0-9]+[.][0-9]+)x$/i.match(c)
      m == nil ? nil : m[1]
    }

    if @args["files"].empty?
      @args["files"] = findInterestingFilesOnCwd
    end
  end

  def findInterestingFilesOnCwd
    p "Collecting files and determining mime types..."
    files = Dir.glob "*"

    # collect all file-types into a hash
    # type => [files]
    h = {}
    files.map{|f| 
      print "."
      key = getMime( f )
      if h[key].nil? then h[key] = [] end 
      h[key].push(f)
    }
    print "\n"

    # find some combination of mime-types that fit a scheme
    keys = []
    keys = h.keys.find_all{|e| not e.index("audio").nil? } if keys.empty?
    keys = h.keys.find_all{|e| not e.index("image").nil? } if keys.empty?
    
    # collect the files from the possible mime types
    keys.empty? ? ["."] : keys.flat_map{|k| h[k]}
  end

  # scan a mime config file and find the execution line
  # e.g. for "mplayer.desktop"
  # return "mplayer %F "
  def getMimeRunnerFor( desktopFile )
    defaultMimePath = "/usr/share/applications/"
    path = defaultMimePath + desktopFile

    # sometimes files have this form: kde4-gwenview.desktop => kde4/gwenview.desktop
    if !File.exists?(path)
      parts = desktopFile.split("-")
      if parts.length >= 2
        path = defaultMimePath + parts[0] + "/" + parts.drop(1).join("-")
      end
    end

    return nil if !File.exists?(path)
    conf = ParseConfig.new( path )
    conf.params["Desktop Entry"]["Exec"]
  end

  # e.g. for "mplayer.desktop" guess "mplayer"
  def guessMimeRunnerFor( desktopFile )
    desktopFile.gsub(/.desktop$/,"") + " %F "
  end

  # e.g.:    for 'video/x-matroska', "/usr/share/applications/mimeinfo.cache", "MIME Cache"
  # returns: 'mplayer.desktop' 
  def getRunnerMetaFromConfig( mime, configfile, key )
    begin
      conf = ParseConfig.new( configfile )
      apps = conf.params[key][mime]
      return nil if apps == nil 
      return apps.split(";")[0]
    rescue
      return nil
    end
  end

  # For a given mime-type, find the system's execution line. Scans a given configfile and key
  # e.g.:    for 'video/x-matroska', "/usr/share/applications/mimeinfo.cache", "MIME Cache"
  # returns: mplayer %F 
  def getRunnerFromConfig( mime, configfile, key )
    desktopFile = getRunnerMetaFromConfig mime, configfile, key
    return nil if desktopFile == nil
    puts "-- desktop file found for mime '#{mime}' in #{configfile} (key: '#{key}')" if @opts[:verbose]

    # get the runner
    runner = getMimeRunnerFor( desktopFile )
    return runner if not runner.nil?

    # if something went wrong, try to guess it:
    runner = guessMimeRunnerFor( desktopFile )
    puts "-- guessing runner via #{desktopFile}, got: '#{runner}'" if not runner.nil? and @opts[:verbose]
    runner
  end

  def getRunnerFromMimeinfoCache( mime )
    key = "MIME Cache"
    path = "share/applications/mimeinfo.cache"
    return  getRunnerFromConfig( mime, File.expand_path( "~/.local/#{path}" ), key) ||
            getRunnerFromConfig( mime, "/usr/#{path}", key)
  end

  def getRunnerFromMimeappList( mime )
    key = "Default Applications"
    path = "share/applications/mimeapps.list"
    return  getRunnerFromConfig( mime, File.expand_path( "~/.local/#{path}" ), key) ||
            getRunnerFromConfig( mime, "/usr/#{path}", key)
  end

  # Some runners are adjusted
  # e.g. mplayer supports factor arguments for speed-stepping
  # so "v 1.5x myfile.mkv" will result in "mplayer -af scaletempo -speed 1.5 myfile.mkv"
  def tweakRunner( r ) 
    if r.match(/^mplayer/)
      speed = getFirstOr( @args["factor"], "1.0" )
      db = getFirstOr( @args["db"], "+0" )
      "#{r} -af volume=#{db}dB,scaletempo -speed #{speed} "
    else r
    end
  end

  # For a given mime-type, find the system's execution line. Scan all relevant files.
  # e.g.:    for 'video/x-matroska'
  # returns: mplayer %F 
  def getRunner( mime )
    runner =  getRunnerFromMimeappList( mime ) ||
              getRunnerFromMimeinfoCache( mime ) ||
              nil
    return nil if runner == nil
    runner = tweakRunner runner
  end

  # Take a runner and fill the placeholders with actual arguments.
  # e.g.:    mplayer %F
  # becomes: mplayer myfile.mkv
  def fillRunnerArgs( file, runner )
    runner = runner.
      gsub( /%F/, "\"" + file + "\"" ).
      gsub( /%U/, "\"" + file + "\"" ).
      gsub( /%u/, "\"" + file + "\"" ).
      gsub( /%i/, @args["icon"] ).
      gsub( /%c/, @args["caption"] )
    runner
  end

end

FileViewer.new(opts).runAll