#!/usr/bin/env ruby

require 'trollop'
require 'mime-helpers'
require 'zlog'
require 'argument-parser'

opts = Trollop::options do
  opt :pretend, "Pretend, don't execute"
  opt :verbose, "Let me know what is happening."
  opt :debug, "Give me everything."
end

Zlog::level = Zlog::VERBOSE if opts[:verbose]
Zlog::level = Zlog::DEBUG if opts[:debug]

class FileViewer
  include MimeHelpers

  # contains the result of parsing commandline arguments
  attr :args

  # parse arguments
  def initialize(opts)
    @opts = opts
    @args = ArgumentParser.new.parse(ARGV)
    Zlog.debug "parsed configuration: #{@args.inspect}"
  end

  # run a given file
  # e.g. for "vid.mkv" execute "mplayer vid.mkv"
  def run( file )
    mime = getMime file
    ( Zlog.error "couldn't determine mime-type for file #{file}"
      return nil ) if mime.nil? or mime.empty?
    Zlog.info "got mime '#{mime}' for #{file}"
    
    exec = getRunner mime, file, @args
    return nil if exec.nil?
    
    Zlog.info "run: #{exec}"
    system( exec ) if not @opts[:pretend]
  end

  # run all files that were given as arguments
  def runAll
    @args["files"].each{|f| run f }
  end

  private

end

FileViewer.new(opts).runAll